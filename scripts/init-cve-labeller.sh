#!/usr/bin/env bash
#
# CVE Labeller Initialization Script
# Runs necessary initialization steps inside the CVE Labeller container
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

CONTAINER_NAME="cloudfest-cve-labeller"

echo -e "${BLUE}Initializing CVE Labeller...${NC}"

# Check if container is running
if ! docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    echo -e "${RED}ERROR: CVE Labeller container is not running${NC}"
    exit 1
fi

# Wait for CVE Labeller to be ready
echo -e "${YELLOW}Waiting for CVE Labeller container to be ready...${NC}"
timeout 60 bash -c "until docker exec -w /app ${CONTAINER_NAME} php -v >/dev/null 2>&1; do sleep 2; done" || {
    echo -e "${RED}CVE Labeller container failed to initialize${NC}"
    exit 1
}

# Check if vendor directory exists and has content
echo -e "${YELLOW}Checking Composer dependencies...${NC}"
if ! docker exec -w /app ${CONTAINER_NAME} test -f vendor/autoload.php 2>/dev/null; then
    echo -e "${YELLOW}Installing Composer dependencies...${NC}"
    docker exec -w /app ${CONTAINER_NAME} composer install --no-interaction --prefer-dist --optimize-autoloader
else
    echo -e "${GREEN}✓ Composer dependencies are installed${NC}"
fi

# Check if APP_KEY is set
echo -e "${YELLOW}Verifying APP_KEY is set...${NC}"
APP_KEY=$(docker exec ${CONTAINER_NAME} printenv APP_KEY 2>/dev/null || echo "")
if [ -z "$APP_KEY" ] || [ "$APP_KEY" = "base64:YourGeneratedAppKeyHere=" ]; then
    echo -e "${YELLOW}Generating APP_KEY...${NC}"
    NEW_KEY=$(docker exec -w /app ${CONTAINER_NAME} php artisan key:generate --show)
    echo -e "${YELLOW}Please update docker-compose.yml with this APP_KEY:${NC}"
    echo -e "${GREEN}${NEW_KEY}${NC}"
    echo ""
    echo -e "${YELLOW}Add this to the cve-labeller service environment:${NC}"
    echo "APP_KEY: ${NEW_KEY}"
    echo ""
    exit 0
fi
echo -e "${GREEN}✓ APP_KEY is configured${NC}"

# Clear and optimize cache
echo -e "${YELLOW}Clearing Laravel cache...${NC}"
docker exec -w /app ${CONTAINER_NAME} php artisan optimize:clear >/dev/null 2>&1 || {
    echo -e "${YELLOW}Warning: Could not clear cache (this is normal on first run)${NC}"
}

# Run database migrations
echo -e "${YELLOW}Running database migrations...${NC}"
docker exec -w /app ${CONTAINER_NAME} php artisan migrate --force --no-interaction || {
    echo -e "${YELLOW}Warning: Migrations may have already been applied${NC}"
}

# Verify database connectivity
echo -e "${YELLOW}Verifying database connectivity...${NC}"
if docker exec -w /app ${CONTAINER_NAME} php artisan migrate:status >/dev/null 2>&1; then
    echo -e "${GREEN}✓ Database connection is working${NC}"
else
    echo -e "${RED}WARNING: Could not verify database connection${NC}"
fi

# Test API endpoint
echo -e "${YELLOW}Testing CVE Labeller API...${NC}"
if docker exec ${CONTAINER_NAME} curl -sf http://localhost:80/api >/dev/null 2>&1; then
    echo -e "${GREEN}✓ CVE Labeller API is responding${NC}"
else
    echo -e "${RED}WARNING: CVE Labeller API is not responding correctly${NC}"
    echo -e "${YELLOW}You may need to restart the container: docker restart ${CONTAINER_NAME}${NC}"
fi

echo -e "${GREEN}CVE Labeller initialization complete!${NC}"
